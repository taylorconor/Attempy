{% extends "base.html" %}

{% block title %}
Editor
{% endblock %}

{% block head %}
<style type="text/css" media="screen">
    #editor {
        display: inline;
        height: 725px;
    }

    #folder-sidebar{
        top: 0;
        left: 0;
        display: inline;
        height: 725px;
        border-radius: 0px !important;
    }

    #folder-sidebar i{
        cursor: pointer;
    }

</style>
{% endblock %}

{% block content %}
<div class="row">
  <div id="folder-sidebar" class="well col-xs-1.5 pull-left"></div>
    <div id="editor" class="col-xs-10 pull-left"></div>
</div>

<textarea id="current_file_name" style="display:none;">TEMPORARY_FILE_NAME.pml</textarea>
<button type="submit" id="submit_save" class="btn btn-default">Save</button>

<!-- Modal -->
<div class="modal fade" id="getNewFileName" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Modal Header</h4>
        </div>
        <div class="modal-body">
          <label for="newFileName">Name:</label>
        <input type="text" class="form-control" id="newFileName" >
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" id="createNewFile" class="btn btn-default" data-dismiss="modal">Submit</button>
        </div>
      </div>
    </div>
  </div>


<script src="{{ url_for('static', filename='ace/build/src/ace.js') }}"
        type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    // dark theme
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/javascript");
    // keybindings for search and replace (win == linux)
    editor.commands.addCommand({
        name: 'replace',
        bindKey: {win: 'Ctrl-R', mac: 'Command-alt-F'},
        exec: function(editor) {
            ace.config.loadModule("ace/ext/searchbox", function(e) {e.Search(editor, true)});
        },
        readOnly: true
    });
</script>
<script>
function loadSideBar(){
    $.ajax({
        url: "{{ url_for('home.pml_load_file_sidebar') }}",
        method: "GET",
        success: function(data) {
            $('#folder-sidebar').html(data.output);
            $('.tree-toggle').click(function () {
                $(this).parent().children('ul.tree').toggle(200);
            });

            var fileName = $('#current_file_name').val();
            var currentFile = $("#folder-sidebar a:contains('"+ fileName +"')");
            currentFile.css( "color", "black" );

            $('#folder-sidebar a').click(function () {
                var filename = $(this).text();
                $.ajax({
                    url: "{{ url_for('home.pml_load_file') }}",
                    method: "POST",
                    data: {
                        data: filename
                    },
                    success: function(data) {
                        editor.setValue(data.output);
                        $('#current_file_name').val(filename);
                        loadSideBar();
                    }
                });
            });

            $('#folder-sidebar .fa-plus-circle').click(function () {
                var path = '';
                var current_folder = $(this).prev();
                var parents = current_folder.parents('#folder-sidebar ul');
                parents.splice(-1,1);
                if(parents.length > 0){
                    parents.splice(-1,1);
                    path += current_folder.text();
                    parents.each(function() {
                        path = $(this).prev().prev().text() + '/' + path;
                    });
                }
                $('#createNewFile').attr( 'folderPath', path );
            });

            $('#createNewFile').click(function () {
                path = $(this).attr('folderPath');
                if (typeof path === typeof undefined || path === false) {
                    path = '';
                }
                path += '/' + $('#newFileName').val();
                $.ajax({
                    url: "{{ url_for('home.createFile') }}",
                    method: "POST",
                    data: {
                        data: path
                    },
                    success: function(data) {
                        $('#newFileName').val('');
                        editor.setValue('');
                        loadSideBar();
                    }
                });
            });
        }
    });
}
$(document).ready(function() {
    loadSideBar();
    $('#submit_save').on('click', function() {
        $.ajax({
            url: "{{ url_for('home.pml_save_file') }}",
            method: "POST",
            data: {
                data: $('#current_file_name').val()
            },
            success: function(data) {
                
            }
        });
    });
});

</script>
{% endblock %}